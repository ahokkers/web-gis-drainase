<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS Drainase Jakarta</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <style>
        /* CSS agar peta memenuhi layar */
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            width: 100%; 
            overflow: hidden; 
        }

        #map { 
            height: 100vh; 
            width: 100%; 
        }

        .info-popup { 
            font-family: Arial, sans-serif; 
            line-height: 1.4; 
            font-size: 13px;
        }

        /* Sedikit penyesuaian agar box pencarian terlihat modern */
        .leaflet-control-geocoder {
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <script src="data_saluranphb.js"></script>
    <script src="data_saluranmikro.js"></script>

    <script>
        // --- INISIALISASI PETA ---
        var map = L.map('map').setView([-6.1993, 106.8203], 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // --- LAYER 1: SALURAN PHB (BLUE) ---
        if (typeof dataTersier !== 'undefined') {
            var saluranLayer = L.geoJSON(dataTersier, {
                style: { color: "blue", weight: 6, opacity: 0.9 },
                onEachFeature: function (feature, layer) {
                    var p = feature.properties;
                    // MENGUBAH ATRIBUT POPUP SALURAN PHB
                    layer.bindPopup(`
                        <div class="info-popup">
                            <b>PHB (Tersier): ${p.toponimi || 'Tanpa Nama'}</b><br>
                            Panjang: ${p.panjang || '-'} m<br>
                            Lebar: ${p.lebar || '-'} m<br>
                            Kedalaman: ${p.kedalaman || '-'} m<br>
                            Kecamatan: ${p.kecamatan || '-'}<br>
                            Shape Leng: ${p.Shape_Leng ? p.Shape_Leng.toFixed(2) : '-'}
                        </div>
                    `);
                }
            }).addTo(map);

            saluranLayer.eachLayer(function(layer) {
                L.polylineDecorator(layer, {
                    patterns: [{
                        offset: '20%', repeat: '50px',
                        symbol: L.Symbol.arrowHead({
                            pixelSize: 10,
                            pathOptions: { fillOpacity: 1, color: 'red', stroke: false }
                        })
                    }]
                }).addTo(map);
            });
            
            map.fitBounds(saluranLayer.getBounds());
        }

        // --- LAYER 2: SALURAN MIKRO (CYAN) ---
        if (typeof dataMikro !== 'undefined') {
            var mikroLayer = L.geoJSON(dataMikro, {
                style: { color: "cyan", weight: 3, opacity: 0.8 },
                onEachFeature: function (feature, layer) {
                    var p = feature.properties;
                    // MENGUBAH ATRIBUT POPUP SALURAN MIKRO
                    layer.bindPopup(`
                        <div class="info-popup">
                            <b>Saluran Mikro: ${p.Name || 'Tanpa Nama'}</b><br>
                            Shape Leng: ${p.Shape_Leng ? p.Shape_Leng.toFixed(2) : '-'}
                        </div>
                    `);
                }
            }).addTo(map);

            mikroLayer.eachLayer(function(layer) {
                L.polylineDecorator(layer, {
                    patterns: [{
                        offset: '30%', repeat: '40px',
                        symbol: L.Symbol.arrowHead({
                            pixelSize: 8,
                            pathOptions: { fillOpacity: 1, color: 'red', stroke: false }
                        })
                    }]
                }).addTo(map);
            });
        }

        // --- FITUR PENCARIAN ALAMAT ---
        var geocoder = L.Control.geocoder({
            defaultMarkGeocode: false,
            placeholder: "Cari lokasi/jalan...",
            errorMessage: "Tidak ditemukan."
        })
        .on('markgeocode', function(e) {
            var center = e.geocode.center;
            map.setView(center, 18); // Zoom ke lokasi hasil pencarian
            L.marker(center).addTo(map)
                .bindPopup(e.geocode.name)
                .openPopup();
        })
        .addTo(map);

        // Perbaikan render peta
        setTimeout(function() {
            map.invalidateSize();
        }, 500);

    </script>
</body>
</html>
